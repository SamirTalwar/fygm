#!/usr/bin/env zsh --login

set -e
set -o pipefail

name=$0
gemfile_contents="source 'https://rubygems.org'

gem 'github-pages'"

function usage {
  echo >&2 "$name init      Sets up the repository and installs the gems."
  echo >&2 "$name update    Updates Ruby and the gems."
  echo >&2 "$name serve     Starts the Jekyll server."
}

if [[ $# -ne 1 ]]; then
  usage
  exit 2
fi

function setup {
  if [[ ! -e Gemfile ]]; then
    <<< $gemfile_contents > Gemfile
  fi
  bundle config --path=.bundle
}

case $1 in
  init)
    setup
    bundle install
    ;;
  update)
    setup
    bundle update
    bundle clean
    ;;
  serve)
    bundle exec jekyll serve --watch --incremental
    ;;
  *)
    usage
    exit 1
    ;;
esac
