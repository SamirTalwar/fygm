#!/usr/bin/env zsh

set -e

IMAGE='jfrog-docker-reg2.bintray.io/jfrog/artifactory-oss'

docker volume create --name=artifactory-backup
docker volume create --name=artifactory-data
docker volume create --name=artifactory-etc
docker volume create --name=artifactory-logs
docker run --rm -v artifactory-etc:/artifactory/etc $IMAGE sh <<< '
  set -e
  if [ ! -e /artifactory/etc ]; then
    cp -R /etc/opt/jfrog/artifactory/* /artifactory/etc
  fi
  chown -R artifactory:artifactory /artifactory
'

docker ps --filter=name=artifactory --filter=status=exited -aq | xargs docker rm
docker run \
  -d \
  --name=artifactory \
  -p 8081:8081 \
  -e ARTIFACTORY_HOME=/var/opt/jfrog/artifactory \
  -v artifactory-etc:/etc/opt/jfrog/artifactory \
  -v artifactory-backup:/var/opt/jfrog/artifactory/backup \
  -v artifactory-data:/var/opt/jfrog/artifactory/data \
  -v artifactory-logs:/var/opt/jfrog/artifactory/logs \
  $IMAGE
