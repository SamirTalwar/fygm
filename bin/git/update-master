#!/bin/bash

set -e
set -u

current_branch="$(git name)"
main_branch="$(git main-branch)"
switched=false

git fetch --all

if git show-ref --verify --quiet "refs/heads/$main_branch"; then
  if [[ "$current_branch" != "$main_branch" ]]; then
    git checkout "$main_branch"
    switched=true
  fi
  git sync
  git delete-old-branches
fi

if [[ "$current_branch" != "$main_branch" ]] && $switched && git show-ref --verify --quiet "refs/heads/$current_branch"; then
  git checkout "$current_branch"
fi

if git symbolic-ref --quiet HEAD >&/dev/null; then
  git pull-everything
fi
